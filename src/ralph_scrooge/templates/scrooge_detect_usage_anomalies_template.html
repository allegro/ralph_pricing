{% load joinby %}
{% load percentage %}
{% load sort %}

{% spaceless %}
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  </head>
  <body>
    <p>Hi {{ recipient.first_name }} {{recipient.last_name }},</p>

    <p>We have detected anomalies in your usages - see below for the details.
    Please fix them ASAP.</p>

    {% if missing_values %}
    <p>Missing usage type values for the following days:</p>

    <table style="border: 1px solid black; border-collapse: collapse">
      <tr>
        <th style="border: 1px solid black; padding: 5px">Date</th>
        <th style="border: 1px solid black; padding: 5px">Usage type(s)</th>
      </tr>
      {% for date_, usage_types in missing_values.items %}
      <tr>
        <td style="border: 1px solid black; padding: 5px">{{ date_|date:"Y-m-d" }}</td>
        <td style="border: 1px solid black; padding: 5px">
          {{ usage_types|sort|joinby:", " }}
        </td>
      </tr>
      {% endfor %}
    </table>

    {% endif %}

    {% if unusual_changes %}
    <p>Unusually big changes in values between the following days:</p>

    <table style="border: 1px solid black; border-collapse: collapse">
      <tr>
        <th style="border: 1px solid black; padding: 5px">Date 1</th>
        <th style="border: 1px solid black; padding: 5px">Date 2</th>
        <th style="border: 1px solid black; padding: 5px">Usage type</th>
        <th style="border: 1px solid black; padding: 5px">Value 1</th>
        <th style="border: 1px solid black; padding: 5px">Value 2</th>
        <th style="border: 1px solid black; padding: 5px">Relative Change (%)</th>
      </tr>
      {% for ch in unusual_changes %}
      <tr>
        <td style="border: 1px solid black; padding: 5px">{{ ch.0|date:"Y-m-d" }}</td>
        <td style="border: 1px solid black; padding: 5px">{{ ch.1|date:"Y-m-d" }}</td>
        <td style="border: 1px solid black; padding: 5px">{{ ch.2.name }}</td>
        <td style="border: 1px solid black; padding: 5px; text-align: right">
          {{ ch.3|floatformat:2 }}
        </td>
        <td style="border: 1px solid black; padding: 5px; text-align: right">
          {{ ch.4|floatformat:2 }}
        </td>
        <td style="border: 1px solid black; padding: 5px; text-align: right">
          {{ ch.5|percentage:"dec=2&sign=true" }}
        </td>
      </tr>
      {% endfor %}
    </table>

    <p>In case you'd find any false positives in the table above, you may
    request change of the "Change Tolerance" param in Scrooge's admin panel
    (requires admin privileges).</p>

    {% endif %}

    {% if reply_to_address %}
    <p>Please note: This e-mail was sent from a notification-only
      address that can't accept incoming e-mail. If you want to
      contact us, please send an e-mail to {{ reply_to_address }}
      instead. Thanks!</p>
    {% endif %}

    <p>Regards,<br>Scrooge Team</p>

  </body>
</html>
{% endspaceless %}
